# ë°±ì—”ë“œ ê°œë°œìë¥¼ ìœ„í•œ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

í”„ë¡ íŠ¸ì—”ë“œ(Flutter Web)ì—ì„œ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í›„ **ì¸ê°€ ì½”ë“œ**ë¥¼ ë°›ì•„ì„œ ë°±ì—”ë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
ë°±ì—”ë“œì—ì„œëŠ” ì´ ì¸ê°€ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ **ì¹´ì¹´ì˜¤ REST API**ë¡œ í† í°ì„ ë°œê¸‰ë°›ê³ , ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•œ í›„ JWT í† í°ì„ ë°œê¸‰í•©ë‹ˆë‹¤.

---

## ğŸ” ì¹´ì¹´ì˜¤ ì•± í‚¤ ì¤€ë¹„

### 1. ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ ë°œê¸‰
- [Kakao Developers](https://developers.kakao.com/) â†’ ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜
- **REST API í‚¤** ë³µì‚¬ (ì˜ˆ: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`)
- âš ï¸ **ë³´ì•ˆ ì£¼ì˜**: í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬ í•„ìˆ˜

### 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```bash
# .env íŒŒì¼
KAKAO_REST_API_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
KAKAO_REDIRECT_URI=http://localhost:8080/auth/kakao/callback
```

---

## ğŸš€ êµ¬í˜„ ë‹¨ê³„

### 1ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¸ê°€ ì½”ë“œ ë°›ê¸°

í”„ë¡ íŠ¸ì—”ë“œê°€ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ (ì°¸ê³ ìš©):
```
1. ì‚¬ìš©ì "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­
2. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
3. ì‚¬ìš©ì ë¡œê·¸ì¸ + ë™ì˜
4. Redirect URIë¡œ ëŒì•„ì˜´ (ì¸ê°€ ì½”ë“œ í¬í•¨)
   ì˜ˆ: http://localhost:8080/auth/kakao/callback?code=ABC123...
5. ë°±ì—”ë“œ API í˜¸ì¶œ: POST /api/v1/auth/kakao
```

---

### 2ï¸âƒ£ ë°±ì—”ë“œ API êµ¬í˜„: POST /api/v1/auth/kakao

#### ìš”ì²­
```http
POST /api/v1/auth/kakao
Content-Type: application/json

{
  "code": "ì¸ê°€_ì½”ë“œ_ë¬¸ìì—´"
}
```

#### ì‘ë‹µ
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "data": {
    "access_token": "JWT_ì•¡ì„¸ìŠ¤_í† í°",
    "refresh_token": "JWT_ë¦¬í”„ë ˆì‹œ_í† í°",
    "user": {
      "id": 1,
      "email": "user@kakao.com",
      "name": "í™ê¸¸ë™",
      "profile_image_url": "https://..."
    },
    "is_new_user": true
  }
}
```

---

### 3ï¸âƒ£ ë°±ì—”ë“œ ì²˜ë¦¬ ë¡œì§ (ìƒì„¸)

#### Step 1: ì¸ê°€ ì½”ë“œë¡œ ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í° ë°›ê¸°

**ì¹´ì¹´ì˜¤ REST API í˜¸ì¶œ:**

```http
POST https://kauth.kakao.com/oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&client_id={REST_API_KEY}
&redirect_uri={REDIRECT_URI}
&code={ì¸ê°€_ì½”ë“œ}
```

**íŒŒë¼ë¯¸í„°:**
- `grant_type`: `authorization_code` (ê³ ì •)
- `client_id`: REST API í‚¤
- `redirect_uri`: í”„ë¡ íŠ¸ì—”ë“œ Redirect URI (ë“±ë¡ëœ ê²ƒê³¼ ë™ì¼í•´ì•¼ í•¨)
- `code`: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°›ì€ ì¸ê°€ ì½”ë“œ

**ì‘ë‹µ:**
```json
{
  "token_type": "bearer",
  "access_token": "ì¹´ì¹´ì˜¤_ì•¡ì„¸ìŠ¤_í† í°",
  "expires_in": 21599,
  "refresh_token": "ì¹´ì¹´ì˜¤_ë¦¬í”„ë ˆì‹œ_í† í°",
  "refresh_token_expires_in": 5183999
}
```

#### Step 2: ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ

**ì¹´ì¹´ì˜¤ REST API í˜¸ì¶œ:**

```http
GET https://kapi.kakao.com/v2/user/me
Authorization: Bearer {ì¹´ì¹´ì˜¤_ì•¡ì„¸ìŠ¤_í† í°}
Content-Type: application/x-www-form-urlencoded
```

**ì‘ë‹µ:**
```json
{
  "id": 1234567890,
  "kakao_account": {
    "email": "user@kakao.com",
    "email_needs_agreement": false,
    "is_email_valid": true,
    "is_email_verified": true,
    "profile": {
      "nickname": "í™ê¸¸ë™",
      "profile_image_url": "https://..."
    }
  }
}
```

#### Step 3: ì‚¬ìš©ì ê³„ì • ìƒì„± ë˜ëŠ” ì¡°íšŒ

**DB í™•ì¸:**
```sql
SELECT * FROM users WHERE kakao_id = 1234567890;
```

**ì‹ ê·œ ì‚¬ìš©ìì¸ ê²½ìš°:**
```sql
INSERT INTO users (kakao_id, email, name, profile_image_url, created_at)
VALUES (1234567890, 'user@kakao.com', 'í™ê¸¸ë™', 'https://...', NOW());
```

**ê¸°ì¡´ ì‚¬ìš©ìì¸ ê²½ìš°:**
```sql
UPDATE users 
SET last_login_at = NOW()
WHERE kakao_id = 1234567890;
```

#### Step 4: JWT í† í° ë°œê¸‰

**JWT Payload:**
```json
{
  "user_id": 1,
  "email": "user@kakao.com",
  "name": "í™ê¸¸ë™",
  "iat": 1234567890,
  "exp": 1234654290
}
```

**JWT ìƒì„±:**
```go
// Go (Fiber) ì˜ˆì œ
token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{
    "user_id": user.ID,
    "email": user.Email,
    "name": user.Name,
    "iat": time.Now().Unix(),
    "exp": time.Now().Add(time.Hour * 24 * 7).Unix(), // 7ì¼
})

accessToken, _ := token.SignedString([]byte(os.Getenv("JWT_SECRET")))
```

#### Step 5: í”„ë¡ íŠ¸ì—”ë“œë¡œ ì‘ë‹µ

```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "dGhpc19pc19yZWZyZXNo...",
    "user": {
      "id": 1,
      "email": "user@kakao.com",
      "name": "í™ê¸¸ë™",
      "profile_image_url": "https://..."
    },
    "is_new_user": true
  }
}
```

---

## ğŸ’» Go (Fiber) êµ¬í˜„ ì˜ˆì œ

### ì „ì²´ ì½”ë“œ

```go
package handlers

import (
    "encoding/json"
    "fmt"
    "io"
    "net/http"
    "net/url"
    "os"
    "time"

    "github.com/gofiber/fiber/v2"
    "github.com/golang-jwt/jwt/v4"
)

// KakaoTokenResponse - ì¹´ì¹´ì˜¤ í† í° ì‘ë‹µ êµ¬ì¡°ì²´
type KakaoTokenResponse struct {
    TokenType    string `json:"token_type"`
    AccessToken  string `json:"access_token"`
    ExpiresIn    int    `json:"expires_in"`
    RefreshToken string `json:"refresh_token"`
}

// KakaoUserInfo - ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ êµ¬ì¡°ì²´
type KakaoUserInfo struct {
    ID           int64 `json:"id"`
    KakaoAccount struct {
        Email   string `json:"email"`
        Profile struct {
            Nickname         string `json:"nickname"`
            ProfileImageURL  string `json:"profile_image_url"`
        } `json:"profile"`
    } `json:"kakao_account"`
}

// LoginWithKakao - ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í•¸ë“¤ëŸ¬
func LoginWithKakao(c *fiber.Ctx) error {
    // 1. ì¸ê°€ ì½”ë“œ ë°›ê¸°
    var req struct {
        Code string `json:"code"`
    }
    
    if err := c.BodyParser(&req); err != nil {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Invalid request body",
        })
    }
    
    if req.Code == "" {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Authorization code is required",
        })
    }
    
    // 2. ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í° ë°›ê¸°
    kakaoToken, err := getKakaoToken(req.Code)
    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   "Failed to get Kakao token: " + err.Error(),
        })
    }
    
    // 3. ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    kakaoUser, err := getKakaoUserInfo(kakaoToken.AccessToken)
    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   "Failed to get user info: " + err.Error(),
        })
    }
    
    // 4. ì‚¬ìš©ì ê³„ì • ìƒì„± ë˜ëŠ” ì¡°íšŒ
    user, isNew, err := findOrCreateUser(kakaoUser)
    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   "Failed to create user: " + err.Error(),
        })
    }
    
    // 5. JWT í† í° ë°œê¸‰
    accessToken, err := generateJWT(user)
    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   "Failed to generate JWT: " + err.Error(),
        })
    }
    
    refreshToken, err := generateRefreshToken(user)
    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   "Failed to generate refresh token: " + err.Error(),
        })
    }
    
    // 6. ì‘ë‹µ
    return c.JSON(fiber.Map{
        "success": true,
        "data": fiber.Map{
            "access_token":  accessToken,
            "refresh_token": refreshToken,
            "user": fiber.Map{
                "id":                user.ID,
                "email":             user.Email,
                "name":              user.Name,
                "profile_image_url": user.ProfileImageURL,
            },
            "is_new_user": isNew,
        },
    })
}

// getKakaoToken - ì¸ê°€ ì½”ë“œë¡œ ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í° ë°›ê¸°
func getKakaoToken(code string) (*KakaoTokenResponse, error) {
    // ìš”ì²­ íŒŒë¼ë¯¸í„°
    data := url.Values{}
    data.Set("grant_type", "authorization_code")
    data.Set("client_id", os.Getenv("KAKAO_REST_API_KEY"))
    data.Set("redirect_uri", os.Getenv("KAKAO_REDIRECT_URI"))
    data.Set("code", code)
    
    // POST ìš”ì²­
    resp, err := http.PostForm("https://kauth.kakao.com/oauth/token", data)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    // ì‘ë‹µ íŒŒì‹±
    body, _ := io.ReadAll(resp.Body)
    
    if resp.StatusCode != 200 {
        return nil, fmt.Errorf("kakao token request failed: %s", string(body))
    }
    
    var tokenResp KakaoTokenResponse
    if err := json.Unmarshal(body, &tokenResp); err != nil {
        return nil, err
    }
    
    return &tokenResp, nil
}

// getKakaoUserInfo - ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
func getKakaoUserInfo(accessToken string) (*KakaoUserInfo, error) {
    // GET ìš”ì²­
    req, _ := http.NewRequest("GET", "https://kapi.kakao.com/v2/user/me", nil)
    req.Header.Set("Authorization", "Bearer "+accessToken)
    req.Header.Set("Content-Type", "application/x-www-form-urlencoded")
    
    client := &http.Client{}
    resp, err := client.Do(req)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    // ì‘ë‹µ íŒŒì‹±
    body, _ := io.ReadAll(resp.Body)
    
    if resp.StatusCode != 200 {
        return nil, fmt.Errorf("kakao user info request failed: %s", string(body))
    }
    
    var userInfo KakaoUserInfo
    if err := json.Unmarshal(body, &userInfo); err != nil {
        return nil, err
    }
    
    return &userInfo, nil
}

// findOrCreateUser - ì‚¬ìš©ì ê³„ì • ìƒì„± ë˜ëŠ” ì¡°íšŒ
func findOrCreateUser(kakaoUser *KakaoUserInfo) (*User, bool, error) {
    // DBì—ì„œ ì¹´ì¹´ì˜¤ IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
    var user User
    result := db.Where("kakao_id = ?", kakaoUser.ID).First(&user)
    
    if result.Error == nil {
        // ê¸°ì¡´ ì‚¬ìš©ì - ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì—…ë°ì´íŠ¸
        db.Model(&user).Update("last_login_at", time.Now())
        return &user, false, nil
    }
    
    // ì‹ ê·œ ì‚¬ìš©ì - ê³„ì • ìƒì„±
    user = User{
        KakaoID:         kakaoUser.ID,
        Email:           kakaoUser.KakaoAccount.Email,
        Name:            kakaoUser.KakaoAccount.Profile.Nickname,
        ProfileImageURL: kakaoUser.KakaoAccount.Profile.ProfileImageURL,
        CreatedAt:       time.Now(),
        LastLoginAt:     time.Now(),
    }
    
    if err := db.Create(&user).Error; err != nil {
        return nil, false, err
    }
    
    return &user, true, nil
}

// generateJWT - JWT ì•¡ì„¸ìŠ¤ í† í° ìƒì„±
func generateJWT(user *User) (string, error) {
    claims := jwt.MapClaims{
        "user_id": user.ID,
        "email":   user.Email,
        "name":    user.Name,
        "iat":     time.Now().Unix(),
        "exp":     time.Now().Add(time.Hour * 24 * 7).Unix(), // 7ì¼
    }
    
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    return token.SignedString([]byte(os.Getenv("JWT_SECRET")))
}

// generateRefreshToken - JWT ë¦¬í”„ë ˆì‹œ í† í° ìƒì„±
func generateRefreshToken(user *User) (string, error) {
    claims := jwt.MapClaims{
        "user_id": user.ID,
        "iat":     time.Now().Unix(),
        "exp":     time.Now().Add(time.Hour * 24 * 30).Unix(), // 30ì¼
    }
    
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    return token.SignedString([]byte(os.Getenv("JWT_SECRET")))
}
```

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### users í…Œì´ë¸”

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    kakao_id BIGINT UNIQUE NOT NULL,
    email VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    profile_image_url TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    last_login_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_kakao_id ON users(kakao_id);
CREATE INDEX idx_users_email ON users(email);
```

---

## ğŸ”’ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] REST API í‚¤ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬
- [ ] JWT Secretì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬
- [ ] HTTPS ì‚¬ìš© (í”„ë¡œë•ì…˜ í•„ìˆ˜)
- [ ] CORS ì„¤ì • (í”„ë¡ íŠ¸ì—”ë“œ ë„ë©”ì¸ë§Œ í—ˆìš©)
- [ ] Rate Limiting ì ìš©
- [ ] SQL Injection ë°©ì§€ (Prepared Statement)
- [ ] XSS ë°©ì§€
- [ ] í† í° ë§Œë£Œ ì‹œê°„ ì„¤ì •

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ë¡œì»¬ í…ŒìŠ¤íŠ¸ (cURL)

```bash
# ì¸ê°€ ì½”ë“œë¡œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
curl -X POST http://localhost:3000/api/v1/auth/kakao \
  -H "Content-Type: application/json" \
  -d '{"code": "ì‹¤ì œ_ì¸ê°€_ì½”ë“œ"}'
```

### 2. API í´ë¼ì´ì–¸íŠ¸ (Postman)

```
POST http://localhost:3000/api/v1/auth/kakao
Content-Type: application/json

{
  "code": "ABC123..."
}
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ REST API](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api)
- [ì¹´ì¹´ì˜¤ í† í° ìš”ì²­](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api#request-token)
- [ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api#req-user-info)

---

**ì‘ì„±ì¼**: 2025-12-05  
**ëŒ€ìƒ**: ë°±ì—”ë“œ ê°œë°œì  
**ì–¸ì–´**: Go (Fiber í”„ë ˆì„ì›Œí¬)
